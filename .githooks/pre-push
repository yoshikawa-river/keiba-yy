#!/bin/bash

set -e

echo "ğŸ” Running pre-push hooks..."

# ãƒªãƒ¢ãƒ¼ãƒˆã¨ãƒ–ãƒ©ãƒ³ãƒã®æƒ…å ±ã‚’å–å¾—
remote="$1"
url="$2"

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
current_branch=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ“¤ Pushing to: $remote ($url)"
echo "ğŸŒ¿ Current branch: $current_branch"

# Dockerç’°å¢ƒãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if ! docker compose ps | grep -q "Up"; then
    echo "âš ï¸  Docker containers are not running. Starting containers..."
    docker compose up -d app
    sleep 5
fi

echo "ğŸ¨ Running code formatting..."

# å¤‰æ›´ã•ã‚ŒãŸPythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
changed_files=$(git diff --name-only HEAD origin/$current_branch 2>/dev/null | grep '\.py$' || true)

if [ -n "$changed_files" ]; then
    echo "ğŸ“ Found Python files to format:"
    echo "$changed_files"
    
    # Ruff format (Black replacement)
    echo "ğŸ¦€ Running Ruff formatter..."
    docker compose exec -T app ruff format src/
    
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! git diff --quiet; then
        echo "âœ… Code has been formatted. Committing changes..."
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add -u
        
        # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆ
        git commit -m "style: auto-format code before push

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
        
        echo "ğŸ“ Formatting commit created automatically"
    else
        echo "âœ… Code is already properly formatted"
    fi
else
    echo "â„¹ï¸  No Python files changed"
fi

echo "ğŸ” Running linting checks..."

# Ruff check (Flake8 replacement)
echo "ğŸ¦€ Running Ruff linting..."
if ! docker compose exec -T app ruff check src/ --output-format=github; then
    echo "âŒ Ruff linting failed!"
    echo "ğŸ’¡ Please fix the linting errors before pushing"
    exit 1
fi

# MyPy type checking (ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– - CIç’°å¢ƒçµ±ä¸€ã®ãŸã‚)
echo "ğŸ” Running MyPy type checking... (DISABLED - CIç’°å¢ƒçµ±ä¸€ä½œæ¥­ä¸­)"
# if ! docker compose exec -T app mypy src/ --show-error-codes --pretty; then
#     echo "âŒ MyPy type checking failed!"
#     echo "ğŸ’¡ Please fix the type errors before pushing"
#     exit 1
# fi

echo "âœ… All pre-push checks passed!"
echo "ğŸš€ Ready to push to $remote"

exit 0