# 競馬予想AI MySQL版 要件定義書

作成日：2025-08-03  
更新日：2025-08-11
プロジェクト：keiba-yy

## 1. プロジェクト概要

### 1.1 背景
- JRA-VANの大規模データを効率的に処理
- リレーショナルデータベースの堅牢性を活用
- everyDB2のテーブル構造との互換性確保
- 機械学習に最適化されたデータ構造の実現

### 1.2 目的
MySQLをベースとした高性能な競馬予想AIシステムの構築

### 1.3 プロジェクト名
`KeibaAI-MySQL`

## 2. システム要件

### 2.1 機能要件

#### データ収集・管理
- JRA-VANデータの効率的な格納と管理
- 1986年以降の全レースデータ（約14万レース）
- インデックス最適化による高速検索
- トランザクション管理による整合性保証

#### 機械学習
- 効率的な特徴量抽出（247個→500個への拡張計画）
- バッチ処理による大規模データ処理
- 実験管理とバージョニング（MLflow統合）
- 予測結果の永続化

#### API・UI
- RESTful API（FastAPI）
- データベース接続プーリング
- 高速なクエリ実行
- モバイル対応

### 2.2 非機能要件

#### パフォーマンス
- 10万レースの特徴量抽出: 60秒以内
- API応答時間: 200ms以内（95パーセンタイル）
- 同時接続: 500ユーザー

#### スケーラビリティ
- データ容量: 初期50GB → 5年後250GB対応
- レプリケーションによる読み取り性能向上
- パーティショニングによる大規模データ対応

#### 可用性
- 99.9%の稼働率
- 自動バックアップ（日次）
- ポイントインタイムリカバリ

## 3. 予測精度目標（野心的設定）

### 3.1 段階的目標設定

#### Phase 1目標（初期リリース）
- **単勝的中率**: 20%以上（業界平均12%を大幅超越）
- **複勝的中率**: 50%以上（堅実な的中率確保）
- **回収率**: 120%以上（20%の利益確保）
- **システム稼働率**: 99.9%

#### Phase 2目標（最適化後）
- **単勝的中率**: 25%以上（プロ級精度）
- **複勝的中率**: 65%以上（高精度複勝予想）
- **回収率**: 140%以上（40%の高利益率）
- **三連複的中率**: 8%以上（高配当狙い）

#### Phase 3目標（究極目標）
- **単勝的中率**: 30%以上（業界最高峰レベル）
- **複勝的中率**: 75%以上（ほぼ確実な複勝予想）
- **回収率**: 160%以上（60%の超高利益率）
- **馬連的中率**: 15%以上（中配当安定獲得）
- **三連単的中率**: 3%以上（超高配当チャレンジ）

### 3.2 精度向上戦略
- **特徴量最適化**: 247→500特徴量への拡張
- **アンサンブル学習**: LightGBM + XGBoost + CatBoost
- **時系列分析**: 最新30レースのトレンド分析
- **外部要因統合**: 天候・馬場・騎手コンディション
- **リアルタイム学習**: レース結果による即座のモデル更新

## 4. 技術スタック

### 4.1 コア技術
```yaml
データベース:
  - MySQL 8.0
  - InnoDB ストレージエンジン

バックエンド:
  - Python 3.11
  - FastAPI
  - SQLAlchemy 2.0
  - PyMySQL

機械学習:
  - scikit-learn
  - LightGBM
  - XGBoost
  - CatBoost（Phase2追加）
  - pandas（データ処理）
  - MLflow（実験管理）

インフラ:
  - Docker & Docker Compose
  - GitHub Actions（CI/CD）
  - AWS RDS（本番環境）
```

### 4.2 フロントエンド
```yaml
Web:
  - React 18
  - TypeScript
  - Tailwind CSS
  - Vite

状態管理:
  - Zustand
  - TanStack Query

可視化:
  - Chart.js
  - D3.js
```

## 5. 実装フェーズ

### Phase 1: 基盤構築（完了）
- ✅ データベース設計・構築
- ✅ 基本的な特徴量抽出（247特徴量）
- ✅ FastAPI基盤実装
- ✅ 認証・WebSocket基盤
- 🚧 MockPredictor → 実MLモデル実装（進行中）

### Phase 2: モデル最適化
- アンサンブル学習実装
- 特徴量拡張（500特徴量）
- バックテストシステム
- 精度向上（単勝25%、回収率140%目標）

### Phase 3: 運用最適化
- リアルタイム学習
- 自動再学習パイプライン
- 高度な推奨システム
- 究極目標達成（単勝30%、回収率160%）

## 6. API予測出力仕様

### 6.1 レース予測レスポンス例
```json
{
  "race_id": "202501010511", 
  "race_name": "有馬記念(G1)",
  "prediction_id": "pred_20250101_001",
  "predicted_at": "2025-01-01T10:00:00",
  "model_version": "v2025.1",
  "predictions": [
    {
      "horse_number": 1,
      "horse_name": "エフフォーリア", 
      "win_probability": 0.25,
      "place_probability": 0.65,
      "predicted_rank": 1,
      "confidence": 0.85,
      "expected_odds": 4.2,
      "recommendation": "A",
      "features": {
        "speed_rating": 92.1,
        "recent_form": 0.78,
        "jockey_skill": 0.95
      }
    }
  ],
  "recommended_bets": [
    {
      "type": "win",
      "horses": [1],
      "confidence": 0.85,
      "expected_return": 4.2
    },
    {
      "type": "exacta",
      "horses": [1, 3],
      "confidence": 0.72,
      "expected_return": 12.5
    }
  ],
  "expected_roi": 1.15,
  "metadata": {
    "processing_time_ms": 450,
    "features_count": 247,
    "data_quality_score": 0.94
  }
}
```

## 7. 成功基準

### 技術指標
- クエリ応答時間: 200ms以内（95パーセンタイル）
- バッチ処理時間: 10万レース60秒以内
- データベース可用性: 99.9%以上

### ビジネス指標
上記「3. 予測精度目標」参照

## 8. リスク管理

### 技術リスク
- データ品質の確保
- モデル過学習の防止
- スケーラビリティ課題

### 対策
- 継続的なデータ検証
- クロスバリデーション実装
- 段階的な負荷テスト

## 9. 今後の拡張計画

### 短期（6ヶ月）
- リアルタイムオッズ更新
- モバイルアプリ対応

### 中期（1年）
- 海外競馬データ対応
- AI予測の説明機能
- 自動投票連携

### 長期（2年）
- ビッグデータ基盤への移行
- マルチテナント化
- API公開とエコシステム構築

---

**更新履歴**
- 2025-08-11: 予測精度目標を野心的レベルに大幅アップデート
- 2025-08-11: Phase別目標設定と精度向上戦略を追加
- 2025-08-11: API出力仕様例を詳細化