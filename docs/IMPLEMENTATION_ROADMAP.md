# 競馬AI 推奨実装順序・ロードマップ

**作成日**: 2025-08-11  
**プロジェクト**: keiba-yy  
**目的**: データなし環境での効率的実装戦略

## 🎯 **実装戦略概要**

mykeibaDBデータ投入待ちの間に、**モックデータを活用してシステム基盤を構築**し、実データ投入と同時に本格運用を開始する戦略。

## 🚀 **推奨実装順序（8タスク）**

### 1️⃣ **モックデータ生成器** (優先度: 🔥 最高)

| 項目 | 内容 |
|------|------|
| **実装期間** | 1-2日 |
| **実装場所** | `src/data/mock/` |
| **依存関係** | なし（即実装可能） |
| **成果物** | JRA-VAN形式のテストデータ生成システム |

#### 実装内容
```python
# src/data/mock/mock_data_generator.py
- 競馬場・レースデータ生成
- 出走馬・騎手・調教師データ生成  
- オッズ・結果データ生成
- 時系列データ（2020-2024年）生成
- 352個特徴量対応データ生成
```

#### 完了条件
- [ ] レース情報の基本構造生成
- [ ] 出走馬データ（最大18頭）生成
- [ ] 過去成績データ（時系列）生成
- [ ] 特徴量抽出パイプライン動作確認

---

### 2️⃣ **LightGBMモデル基盤** (優先度: 🔥 最高)

| 項目 | 内容 |
|------|------|
| **実装期間** | 2-3日 |
| **実装場所** | `src/ml/models/lightgbm/` |
| **依存関係** | モックデータ生成器 |
| **成果物** | マルチクラス分類・回帰・ランキング学習モデル |

#### 実装内容
```python
# src/ml/models/lightgbm/
├── base_model.py          # LightGBMベースクラス
├── classification.py      # 順位予測（マルチクラス）
├── regression.py          # タイム・オッズ予測
├── ranking.py            # ランキング学習
└── optimizer.py          # Optuna最適化
```

#### 完了条件
- [ ] マルチクラス分類モデル（1-18位予測）
- [ ] 回帰モデル（タイム予測）
- [ ] ランキング学習モデル（順位学習）
- [ ] Optunaハイパーパラメータ最適化
- [ ] モックデータでの学習・予測動作確認

---

### 3️⃣ **FastAPI予測エンドポイント** (優先度: 🔥 最高)

| 項目 | 内容 |
|------|------|
| **実装期間** | 2-3日 |
| **実装場所** | `src/api/routers/prediction.py` |
| **依存関係** | LightGBMモデル完了 |
| **成果物** | レース予測・バッチ予測API |

#### 実装内容
```python
# src/api/routers/prediction.py
- POST /predict/race     # 単一レース予測
- POST /predict/batch    # 複数レース予測
- GET  /predict/history  # 予測履歴
- GET  /models/info      # モデル情報
```

#### 完了条件
- [ ] 単一レース予測API（レスポンス200ms以内）
- [ ] バッチ予測API（並列処理対応）
- [ ] エラーハンドリング・バリデーション
- [ ] OpenAPI文書自動生成
- [ ] モックデータでの動作確認

---

### 4️⃣ **XGBoostモデル** (優先度: ⚡ 中)

| 項目 | 内容 |
|------|------|
| **実装期間** | 2-3日 |
| **実装場所** | `src/ml/models/xgboost/` |
| **依存関係** | LightGBM完了 |
| **成果物** | GPU対応XGBoostモデル・性能比較 |

#### 実装内容
- GPU高速化対応
- 分散学習対応（Dask）
- LightGBMとの性能比較
- カスタム目的関数（競馬特化）

---

### 5️⃣ **MLflow実験管理** (優先度: ⚡ 中)

| 項目 | 内容 |
|------|------|
| **実装期間** | 1-2日 |
| **実装場所** | `src/ml/experiment/` |
| **依存関係** | なし（並行実装可能） |
| **成果物** | 実験追跡・モデルレジストリ |

#### 実装内容
- MLflowサーバー設定完成
- 実験追跡システム
- モデルバージョニング
- メトリクス自動記録

---

### 6️⃣ **JWT認証システム** (優先度: ⚡ 中)

| 項目 | 内容 |
|------|------|
| **実装期間** | 1-2日 |
| **実装場所** | `src/api/auth/` |
| **依存関係** | FastAPI基盤完了 |
| **成果物** | API セキュリティ・アクセス制御 |

---

### 7️⃣ **アンサンブルモデル** (優先度: ⚡ 中)

| 項目 | 内容 |
|------|------|
| **実装期間** | 2-3日 |
| **実装場所** | `src/ml/models/ensemble/` |
| **依存関係** | LightGBM・XGBoost完了 |
| **成果物** | Voting・Stacking・Blending |

---

### 8️⃣ **WebSocketリアルタイム** (優先度: 🛠️ 低)

| 項目 | 内容 |
|------|------|
| **実装期間** | 2-3日 |
| **実装場所** | `src/api/websocket/` |
| **依存関係** | 認証システム完了 |
| **成果物** | オッズ更新配信・レース結果速報 |

## 📅 **実装スケジュール**

### Week 1: 基盤構築フェーズ
- **Day 1-2**: 1️⃣モックデータ生成器
- **Day 3-5**: 2️⃣LightGBMモデル基盤
- **Day 6-7**: 5️⃣MLflow並行実装

### Week 2: API・モデル拡張フェーズ  
- **Day 1-3**: 3️⃣FastAPI予測エンドポイント
- **Day 4-6**: 4️⃣XGBoostモデル
- **Day 7**: 6️⃣JWT認証システム

### Week 3: 高度機能フェーズ
- **Day 1-3**: 7️⃣アンサンブルモデル
- **Day 4-6**: 8️⃣WebSocketリアルタイム
- **Day 7**: 統合テスト・最終調整

## 🎛️ **実装パラメータ**

### 品質基準
- **コードカバレッジ**: 80%以上
- **API応答時間**: 200ms以内  
- **モデル学習時間**: 1時間以内（モックデータ）
- **メモリ使用量**: 8GB以内

### テスト戦略
```python
tests/
├── unit/           # 単体テスト（各モジュール）
├── integration/    # 統合テスト（API・ML）
├── performance/    # 性能テスト（速度・メモリ）
└── mock_data/     # モックデータ検証テスト
```

## 🚨 **リスク・対策**

| リスク | 影響度 | 対策 |
|-------|--------|------|
| モックデータの品質不足 | 高 | 実データ構造の詳細調査・段階的改善 |
| モデル過学習 | 中 | クロスバリデーション・正則化強化 |
| API性能不足 | 中 | 非同期処理・キャッシュ最適化 |
| 実データ投入時の互換性 | 高 | インターフェース標準化・抽象化 |

## 🎯 **完了後のメリット**

### 即時効果
1. **実データ投入と同時に本格運用開始**
2. **モデル精度評価の即時実行**  
3. **API経由でのリアルタイム予測**

### 長期効果
1. **継続的な機械学習パイプライン**
2. **実験管理による継続改善**
3. **スケーラブルなシステム基盤**

## 📝 **進捗管理**

- **進捗追跡**: [PROGRESS_DASHBOARD.md](./PROGRESS_DASHBOARD.md)
- **詳細タスク**: 各フェーズの設計書参照
- **更新頻度**: タスク開始・完了時リアルタイム更新

---

**次のアクション**: 1️⃣モックデータ生成器実装開始